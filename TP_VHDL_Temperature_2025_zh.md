# TP EC3 - VHDL 1
## TP VHDL 3 & 4：温度传感器接口

### 目的：
本实验的目的是实现对Nexys A7板上已集成的Analog Device ADT7420传感器测量的温度值进行周期性读取。该温度传感器默认分辨率为13位（0.0625 °C/LSB），每240毫秒进行一次转换。转换结果存储在传感器的地址0和1处的两个8位寄存器中，可通过I2C串行通信总线进行读取，传感器的7位地址为“1001011”（0x4B）。测得的13位值构成了如下表所示的13个最高有效位。当温度为正时，符号位D12为零。

**寄存器 0**
| D12 | D11 | D10 | D9 | D8 | D7 | D6 | D5 | D4 | D3 | D2 |
|---|---|---|---|---|---|---|---|---|---|---|

**寄存器 1**
| D1 | D0 | X | X | X |
|---|---|---|---|---|

接下来，需要使用板上可用的7段数码管以十进制格式显示该值。

完整的应用程序RTL图见下一页。

在第一阶段，仅需实现 `main`、`temp_reader`、`clk_div` 和 `sampling_controller` 实体。`i2c_master` 实体已提供。

在第二阶段，将设计并添加到主文件中的是显示实体 `temp_decoder`、`seg_counter` 和 `seg_mux`。

---

# TP EC3 - VHDL 2
（RTL原理图）

---

# TP EC3 - VHDL 3
## 第1部分：读取二进制温度值（4小时）

借助传感器文档（第17至19页）以及所提供的 `i2c_master` 实体文档，您将创建一个 `temp_reader` 实体，用于发送读取温度值所需的I2C命令，并返回从传感器读取的值。

*   确定要发送到传感器的I2C写和读命令，以读取温度值。
*   `i2c_master` 实体的哪个输出将用于同步这些命令的连续触发？
*   如何控制 `i2c_master` 实体的 `ena` 信号，以确保命令连续发送而实体不会在I2C总线上发出STOP条件？
*   绘制状态机，其输出将控制 `i2c_master` 实体的 `addr`、`ena`、`rw` 和 `data_rw` 输入。一个外部 `trig` 信号将触发新的读取，一个 `busy` 输出将向外部实体指示正在进行读取。
*   在此状态机中适时添加对 `data_rw` 信号的读取，以将传感器寄存器0和1的值相继存储到一个16位的 `STD_LOGIC_VECTOR` 信号中。
*   在 `temp_reader` 实体中实现并仿真此状态机。
*   创建一个 `main` 主文件，其输入为板上的时钟信号 `clock` 和复位信号 `reset`。该实体将具有以下输出：
    *   `LED`：一个16位的二进制温度值向量。
    *   `JA`：一个代表JA端口2个引脚的2位向量。
*   对于I2C总线，`scl` 信号将声明为输出（out），`sda` 信号将声明为输入输出（inout）。
*   创建一个时钟分频器 `clk_div` 以生成一个约3Hz的时钟信号 `clk_sampling`，以及一个 `sampling_controller` 实体，其作用是根据 `busy` 信号为 `temp_reader` 的 `trig` 输入创建一个合适的脉冲。
*   在主文件中实例化这两个实体以及 `i2c_master` 和 `temp_reader` 实体。`i2c_master` 实体的 `sda` 和 `scl` 信号将同时连接到 `main` 实体的I2C总线和JA端口的2个引脚，以提供调试可能性。
*   使用PlanAhead软件分配输入/输出，关联：
    *   `clock` 输入到板上的100 MHz晶振。
    *   `reset` 输入到中间的按钮。
    *   16位向量到板上的16个LED。
    *   I2C总线的 `sda` 和 `scl` 信号到温度传感器的引脚。
    *   `JA` 信号的2位到对应的JA端口引脚。

## 第2部分：二进制值解码（2小时）

在这一部分，需要将包含二进制温度值的16位 `STD_LOGIC_VECTOR` 信号转换为3个独立的4位BCD信号：

*   十位度的值；
*   个位度的值；
*   十分之一度的值。

这三个信号随后将用于在7段数码管上显示温度值。

---

# TP EC3 - VHDL 4
*   确定要设计的 `temp_decoder` 实体的输入/输出，该实体将负责此解码的实现。

`binary_bcd` 实体用于解码整数值，并在输出端返回包含单位、十位、百位等（总共最多5位数）的4位信号。

*   该实体应应用于包含温度值的16位信号的哪些位以执行转换？
*   实例化 `binary_bcd` 实体，以实现对温度整数部分的转换。

对于十分之一度，需要将二进制小数部分近似为十进制小数。

*   借助适当的并发指令，描述将剩余的二进制小数转换为一个4位BCD值的转换表，该值将构成十分之一度。
*   使用16位值 `« 0000 1100 1000 1000 »`（对应于25.1°C）来仿真 `temp_decoder` 实体，以验证其正常工作。

## 第3部分：十进制值显示（2小时）

板上右侧的四个7段数码管将分别用于显示：

*   十位度的值；
*   带小数点的个位度的值；
*   十分之一度的值；
*   单位符号 « ° »。

*   根据需要多次实例化 `bcd2seg` 实体，以将单位、十位和十分之一度的BCD值转换为7段格式。
*   创建进入8:1多路复用器 `seg_mux` 输入所需的信号，该多路复用器实现在8个7段数码管上顺序显示8个输入，包括小数点。
*   在 `clk_div` 实体的输出端添加一个额外的时钟 `clk_display`，其频率应约为6 kHz。
*   创建一个计数器 `seg_counter`，它将用作多路复用器的选择器，基于 `clk_display` 显示时钟。
*   修改 `main` 主实体以集成在7段数码管上显示十进制值所需的输出，并将其添加到约束文件中。
