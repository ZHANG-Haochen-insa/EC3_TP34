## Sampling Controller 状态机解析

根据老师白板上画的状态机，我来详细解释：

### 状态机图（整理后）

```
                          rst = '1'
                             │
                             ▼
                      ┌─────────────┐
          ┌──────────▶│  state_idle │
          │           │             │
          │           │ trig <= '0' │
          │           └──────┬──────┘
          │                  │
          │                  │ clk_sampling = '1'
          │                  ▼
          │           ┌─────────────┐
          │           │ state_start │
          │           │             │
          │           │ trig <= '1' │◀─── 产生触发脉冲！
          │           └──────┬──────┘
          │                  │
          │                  │ busy = '1'
          │                  ▼
          │           ┌─────────────┐
          │           │ state_wait  │
          │           │             │
          │           │ trig <= '0' │
          │           └──────┬──────┘
          │                  │
          │                  │ busy = '0' AND clk_sampling = '0'
          └──────────────────┘
```

-----

### 逻辑解释

**整体目的**：每当 `clk_sampling` 变高时，产生一个 `trig` 脉冲去触发温度读取，然后等待读取完成。

#### 状态1：state_idle（空闲等待）

```
输出：trig <= '0'
等待：clk_sampling 变成 '1'
```

- 系统空闲，等待下一次采样时刻
- `clk_sampling` 是 3Hz 的慢时钟，大约每 333ms 变高一次

#### 状态2：state_start（触发开始）

```
输出：trig <= '1'  ← 这里产生触发信号！
等待：busy 变成 '1'
```

- 发出 `trig = '1'`，告诉 `temp_reader` “开始读温度”
- `temp_reader` 收到后会把自己的 `busy` 置 ‘1’
- 一旦检测到 `busy = '1'`，说明读取已经开始，进入等待状态

#### 状态3：state_wait（等待完成）

```
输出：trig <= '0'
等待：busy = '0' AND clk_sampling = '0'
```

- `trig` 恢复为 ‘0’（脉冲结束）
- 等待两个条件同时满足：

1. `busy = '0'` → 温度读取完成了
1. `clk_sampling = '0'` → 采样时钟已经回到低电平

**为什么要等 clk_sampling = ‘0’？** 防止在同一个采样周期内重复触发！

-----

### 时序图

```
clk_sampling: ────┐           ┌─────────────────────────┐           ┌────
                  │           │                         │           │
                  └───────────┘                         └───────────┘

state:        idle │  start   │         wait            │   idle    │ ...

trig:         ─────┌───┐──────────────────────────────────────────────────
                   │   │
                   └───┘
                   
busy:         ──────────┌─────────────────────────┐────────────────────────
(来自temp_               │      正在读取温度        │
 reader)                 └─────────────────────────┘

              ↑          ↑                         ↑                 ↑
              │          │                         │                 │
           检测到      busy=1                   busy=0 且         下一个
           clk_sampling 进入wait              clk_sampling=0     采样周期
           =1，产生trig                        返回idle
```

-----

